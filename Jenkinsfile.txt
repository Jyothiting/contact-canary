pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "jyothi235/contact-book"
  }

  stages {

    stage("Checkout") {
      steps {
        git 'https://github.com/Jyothiting/contact-book-app.git'
      }
    }

    stage("Build Image") {
      steps {
        sh "docker build -t $DOCKER_IMAGE:canary ."
      }
    }

    stage("Push Image") {
      steps {
        sh "docker push $DOCKER_IMAGE:canary"
      }
    }

    stage("Deploy Canary") {
      steps {
        sh "kubectl apply -f k8s/canary-deployment.yaml"
        sh "kubectl apply -f k8s/service.yaml"
      }
    }
  }
}
